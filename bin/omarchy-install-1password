#!/usr/bin/env bash
# Install 1Password on aarch64 systems
# The AUR PKGBUILD is x86_64-only, so we install manually from official tarball

set -euo pipefail

VERSION="8.12.0"
ARCH_SUFFIX="arm64"
INSTALL_DIR="/opt/1Password"
BIN_LINK="/usr/local/bin/1password"

# Only run on aarch64
if [ "$(uname -m)" != "aarch64" ]; then
    echo "Skipping: 1Password aarch64 installer only runs on aarch64 architecture"
    exit 0
fi

# Check if already installed
if [ -f "${BIN_LINK}" ] && [ -d "${INSTALL_DIR}" ]; then
    INSTALLED_VERSION=$("${BIN_LINK}" --version 2>/dev/null || echo "unknown")
    echo "1Password already installed (version: ${INSTALLED_VERSION})"
    exit 0
fi

echo "Installing 1Password ${VERSION} for aarch64..."

# Create temp directory
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

cd "$TMPDIR"

# Download aarch64 tarball
echo "Downloading 1Password ${VERSION} for aarch64..."
curl -fsSL "https://downloads.1password.com/linux/tar/stable/aarch64/1password-${VERSION}.arm64.tar.gz" -o 1password.tar.gz

# Extract
echo "Extracting..."
tar -xzf 1password.tar.gz

# Install to /opt
echo "Installing to ${INSTALL_DIR}..."
sudo rm -rf "${INSTALL_DIR}"
sudo mv "1password-${VERSION}.${ARCH_SUFFIX}" "${INSTALL_DIR}"

# Set permissions
sudo chown -R root:root "${INSTALL_DIR}"
sudo chmod 4755 "${INSTALL_DIR}/chrome-sandbox"

# Create symlink
echo "Creating symlink..."
sudo ln -sf "${INSTALL_DIR}/1password" "${BIN_LINK}"

# Install desktop file
echo "Installing desktop file..."
sudo mkdir -p /usr/share/applications
sudo cp "${INSTALL_DIR}/resources/1password.desktop" /usr/share/applications/

# Install icons
echo "Installing icons..."
for size in 32x32 64x64 256x256 512x512; do
    sudo mkdir -p "/usr/share/icons/hicolor/${size}/apps"
    sudo cp "${INSTALL_DIR}/resources/icons/hicolor/${size}/apps/1password.png" \
        "/usr/share/icons/hicolor/${size}/apps/" 2>/dev/null || true
done

# Update icon cache
sudo gtk-update-icon-cache -f /usr/share/icons/hicolor/ 2>/dev/null || true

# Install polkit policy
echo "Installing polkit policy..."
POLICY_OWNERS=$(cut -d: -f1,3 /etc/passwd | grep -E ':[0-9]{4}$' | cut -d: -f1 | head -n 10 | sed 's/^/unix-user:/' | tr '\n' ' ')
sudo bash -c "export POLICY_OWNERS='${POLICY_OWNERS}'; eval \"cat <<EOF
\$(cat ${INSTALL_DIR}/com.1password.1Password.policy.tpl)
EOF\" > /usr/share/polkit-1/actions/com.1password.1Password.policy"

echo "âœ“ 1Password ${VERSION} installed successfully"
echo "  Run: 1password"
