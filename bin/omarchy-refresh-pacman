#!/bin/bash

# Overwrite the package configuration for /etc/pacman with the Omarchy default of using its dedicated mirrors and repositories, then update all packages.
# This is used after switching between Omarchy release channels to ensure the right packages for the right channel are available.

# Take backup of existing files
sudo cp -f /etc/pacman.conf /etc/pacman.conf.bak
sudo cp -f /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak

sudo cp -f ~/.local/share/omarchy/default/pacman/pacman.conf /etc/pacman.conf

# Detect host architecture to choose appropriate mirrorlist for aarch64 (Asahi/Arch Linux ARM)
ARCH="$(uname -m)"

if [[ $1 == "edge" ]]; then
  if [[ "$ARCH" == "aarch64" ]]; then
    # For aarch64 systems (Asahi/Arch Linux ARM), use the bundled Arch Linux ARM mirrorlist
    sudo cp -f ~/.local/share/omarchy/default/pacman/mirrorlist /etc/pacman.d/mirrorlist
  else
    sudo cp -f ~/.local/share/omarchy/default/pacman/mirrorlist-edge /etc/pacman.d/mirrorlist
  fi
  echo "Setting channel to edge"
else
  # Stable channel: prefer the stable mirrorlist if present. For aarch64, use the Arch Linux ARM mirrorlist.
  if [[ "$ARCH" == "aarch64" ]]; then
    sudo cp -f ~/.local/share/omarchy/default/pacman/mirrorlist /etc/pacman.d/mirrorlist
  else
    if [[ -f ~/.local/share/omarchy/default/pacman/mirrorlist-stable ]]; then
      sudo cp -f ~/.local/share/omarchy/default/pacman/mirrorlist-stable /etc/pacman.d/mirrorlist
    else
      sudo cp -f ~/.local/share/omarchy/default/pacman/mirrorlist /etc/pacman.d/mirrorlist
    fi
  fi
  echo "Setting channel to stable"
fi

echo

# Reset all package DBs and then update
sudo pacman -Syyu --noconfirm
