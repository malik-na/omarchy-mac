#!/bin/bash

# Compare kernel version before and after updates
kernel_before=$(cat /tmp/omarchy-kernel-before 2>/dev/null)

kernel_pkg=""
if rpm -q kernel-core >/dev/null 2>&1; then
  kernel_pkg="kernel-core"
elif rpm -q kernel-16k-core >/dev/null 2>&1; then
  kernel_pkg="kernel-16k-core"
fi

if [ -n "$kernel_pkg" ]; then
  kernel_after=$(rpm -q --qf '%{VERSION}-%{RELEASE}.%{ARCH}\n' "$kernel_pkg" 2>/dev/null | sort -V | tail -1)
else
  kernel_after=""
fi

rm -f /tmp/omarchy-kernel-before

if [ -n "$kernel_before" ] && [ "$kernel_before" != "$kernel_after" ]; then
  gum confirm "Linux kernel has been updated. Reboot?" && omarchy-state clear re*-required && sudo reboot now

elif [ -f "$HOME/.local/state/omarchy/reboot-required" ]; then
  gum confirm "Updates require reboot. Ready?" && omarchy-cmd-reboot
fi

for file in "$HOME"/.local/state/omarchy/restart-*-required; do
  if [ -f "$file" ]; then
    filename=$(basename "$file")
    service=$(echo "$filename" | sed 's/restart-\(.*\)-required/\1/')
    echo "Restarting $service"
    omarchy-state clear "$filename"
    omarchy-restart-"$service"
  fi
done
