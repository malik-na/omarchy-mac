#!/bin/bash

set -euo pipefail

repo="$OMARCHY_PATH"

if upstream_ref=$(git -C "$repo" rev-parse --abbrev-ref --symbolic-full-name '@{u}' 2>/dev/null); then
  read -r behind ahead < <(git -C "$repo" rev-list --left-right --count "HEAD...$upstream_ref" | awk '{print $2, $1}')

  if ((behind > 0)); then
    echo "Omarchy update available ($behind commit(s) behind $upstream_ref)"
    exit 0
  fi

  current_branch=$(git -C "$repo" rev-parse --abbrev-ref HEAD)
  current_commit=$(git -C "$repo" rev-parse --short HEAD)
  echo "Omarchy is up to date on $current_branch ($current_commit)"
  exit 1
fi

current_branch=$(git -C "$repo" rev-parse --abbrev-ref HEAD)
current_commit=$(git -C "$repo" rev-parse --short HEAD)

echo "Omarchy is up to date (no upstream tracking branch for $current_branch, at $current_commit)"
exit 1
