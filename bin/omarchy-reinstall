#!/bin/bash

set -e

if [ "$EUID" -eq 0 ]; then
  echo "Error: This script should not be run as root"
  exit 1
fi

echo -e "This will reinstall all the default Omarchy packages and reset all default configs.\nWarning: All changes to configs will be lost.\n"

if gum confirm "Are you sure you want to reinstall and lose all config changes?"; then
  echo "Resetting Omarchy repository"
  git clone --branch fedora "https://github.com/malik-na/omarchy-mac.git" ~/.local/share/omarchy-new >/dev/null
  rm -rf "$OMARCHY_PATH"
  mv ~/.local/share/omarchy-new "$OMARCHY_PATH"

  echo "Reinstalling missing Omarchy packages"
  mapfile -t packages < <(grep -v '^#' "$OMARCHY_PATH/install/omarchy-base.packages.fedora" | grep -v '^$')
  sudo dnf install -y "${packages[@]}"

  echo "Resetting all Omarchy configs"
  cp -R ~/.local/share/omarchy/config/* ~/.config/
  cp ~/.local/share/omarchy/default/bashrc ~/.bashrc
  echo '[[ -f ~/.bashrc ]] && . ~/.bashrc' | tee ~/.bash_profile >/dev/null

  bash "$OMARCHY_PATH/install/config/theme.sh"
  bash "$OMARCHY_PATH/install/config/git.sh"

  omarchy-refresh-plymouth
  omarchy-lazyvim-setup
fi
