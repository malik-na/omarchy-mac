#!/bin/bash
set -e

# Attempt to reinstall all default Omarchy packages and reset all the default configs.

echo -e "This will reinstall all the default Omarchy packages and reset all default configs.\nWarning: All user changes to configs will be lost.\n"

if gum confirm "Are you sure you want to reinstall and lose all config changes?"; then
  omarchy-reinstall-git
  omarchy-reinstall-pkgs
  omarchy-reinstall-configs

  echo "Reinstalling missing Omarchy packages"
  mapfile -t packages < <(grep -v '^#' "$OMARCHY_PATH/install/omarchy-base.packages" | grep -v '^$')
  sudo pacman -Syu --noconfirm --needed "${packages[@]}"

  echo "Resetting all Omarchy configs"
  cp -R ~/.local/share/omarchy/config/* ~/.config/
  cp ~/.local/share/omarchy/default/bashrc ~/.bashrc
  echo '[[ -f ~/.bashrc ]] && . ~/.bashrc' | tee ~/.bash_profile >/dev/null

  $(bash $OMARCHY_PATH/install/config/theme.sh)
  $(bash $OMARCHY_PATH/install/config/git.sh)

  omarchy-refresh-limine
  omarchy-refresh-plymouth
  omarchy-lazyvim-setup
  gum confirm "System has been reinstalled. Reboot?" && omarchy-cmd-reboot
fi
