#!/bin/bash

set -e

# Ensure screensaver/sleep doesn't set in during updates
hyprctl dispatch tagwindow +noidle &> /dev/null || true

# Capture update logs
exec > >(tee "/tmp/omarchy-update.log") 2>&1

# Perform all update steps
omarchy-update-time

# Save newest installed kernel package version before updates.
kernel_pkg=""
if rpm -q kernel-core >/dev/null 2>&1; then
  kernel_pkg="kernel-core"
elif rpm -q kernel-16k-core >/dev/null 2>&1; then
  kernel_pkg="kernel-16k-core"
fi

if [ -n "$kernel_pkg" ]; then
  rpm -q --qf '%{VERSION}-%{RELEASE}.%{ARCH}\n' "$kernel_pkg" 2>/dev/null | sort -V | tail -1 > /tmp/omarchy-kernel-before
else
  : > /tmp/omarchy-kernel-before
fi

omarchy-update-available-reset
omarchy-update-system-pkgs
omarchy-migrate
omarchy-hook post-update

omarchy-update-analyze-logs

omarchy-update-restart

# Re-enable screensaver/sleep after updates
hyprctl dispatch tagwindow -- -noidle &> /dev/null || true
